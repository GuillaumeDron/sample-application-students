language: java
jdk: oraclejdk8

services:
- docker

before_install:
- openssl aes-256-cbc -K $encrypted_c6df5f81db20_key -iv $encrypted_c6df5f81db20_iv
  -in travis_deploy_rsa.enc -out travis_deploy_rsa -d
- sudo service mysql stop
- docker pull takimatraining/devops-training-db
- docker run -d -p 127.0.0.1:3306:3306 takimatraining/devops-training-db
# Prepare deploy
  - openssl aes-256-cbc -K $encrypted_xxxxxxx_key -iv $encrypted_xxxxxxxxxxx_iv
    -in travis_deploy_rsa.enc -out /tmp/travis_deploy_rsa -d  # Généré par travis encrypt-file
  - chmod 600 /tmp/travis_deploy_rsa
  - eval "$(ssh-agent -s)"
  - ssh-add /tmp/travis_deploy_rsa
  - echo -e "Host $SERVER_HOST\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

script:
- |
  mvn clean install sonar:sonar \
  -Dsonar.projectKey=GuillaumeDron_sample-application-students \
  -Dsonar.organization=guillaumedron-github \
  -Dsonar.host.url=https://sonarcloud.io \
  -Dsonar.login=$SONAR_TOKEN

  # Login to Docker hub
- docker login -u $DOCKER_USER -p $DOCKER_PASS
- export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH;
  fi`
- export IMAGE_NAME=gdron/sample-application
- docker build -t $IMAGE_NAME:$TRAVIS_COMMIT .
- docker tag $IMAGE_NAME:$TRAVIS_COMMIT $IMAGE_NAME:$TAG
- docker push $IMAGE_NAME:$TAG
cache:
  directories:
  - "$HOME/.m2/repository"
env:
  global:
  - secure: VfCIvK1FNlIqT7uNvSBu3GXoNty7pQ1cLYlbynTvileSzwTrQzfu5tIOIMDaDGMdKxzdJk3ClyjaXZyznnghQHnxE1vm2d/v5zSUsPDyY/Q0piSKAgZh9ilDzWk12M9smFDbyi29F1j3YCyobw/9EgSK4ePP5q7uqLkXODOPh8bs14QQAUmq7D7IJwaXGKiGSrJY1KAVyQlCrld+KENa8xKVpVWN5B1t3kCwwwIFjJ/GLdbN7whbCm0kQiu8DysTTaY61iHYXvBgYn/cxwmb47jUTa+681OD0Gq3TqmsXK7fmVICojxq13jVy9SLdKx3lTIZccKyfzPPPcSkqU+bcmrCBeO00Fby824VkQ/0wwElgAmS+Npy7cBQ0YWpkOS7TnEpN0xnzVqqhO6kJ/JgtYelEO0VCzf+tds4/T/xo84WPPrrWtWTNByj/GOlgYMmgIwRYti4UODVt01Ra8ts90B1fK1gkWJsqRXM2686eRvo4BcgVn+juCgRxL5NG+pUyec0iMU3YDgw/Lnoxf9nlzXbqnvNf8/T60vs/K6rNASoXByhb4BIRl1DkvhSxTDzoqx8Fzlolhr7E9036g+vxljiMWZSxgszrTdIAF2UiL9YoQVLRyoUtsbSBE0mvOgSXMRFq6NQyNuQ5J1tA9ya7KRraVQ9TF42nJW+C47/6po=
  - secure "QjpflU5kViQTGaxoBcL8aVZ47Mw5G41EOUmwXpJ7yACIMSkoVBxxQlBZAmIbdK5c2ja6wZFiA3yON/84gKiywcJUlTd6UwKtvN1l+k/w0Lo4vuciwcw0HB94AjcI0WMqcjX9d8T6Q+utpoF6r3BxNlf3z0wDsCo5Ya5AOFE07HT27gUtYRaVcBwHdw2ncAcvhW8kRguyBu+uc8OKuxkUwyjezPbnII/QP9Zcfss8zRP7KWQvrKbw5JHAFs9yb3MbsNoZ1guP/gKoV+orLOktv/+N9BoeqODILTDCH8Pq+YnwyevmHe2FZuABP6XW4i4JidvsGjYjSM40tT1GbC4S8dBV+khSa+litwUyNaLY2U7835SHdWOncP3sXSSwTiLu5j/BVJTR1C170PR0wl4O7AdfaUgzWzHtDCpds6aMIhxVFOzuQIGWcU7Mfy6uUTva82Gr/VqZqEuH7+NtlAntTckZjRk4uv695oFll6/cSEcDLT/Mn8JFWm/noJdvMKgRmFBvIiD06IcURxGND+3Pt7KTmaoXbInwIXEqHav8Z4+JFempk5w5VLctlQebmk36tQxkPpftLDT5tHtF+Fadht//fF787jp66ieJbPN/Cir7qyUlWyCMmJZro129sXnP5AD2nHrWj3nmlyoWs3UG5hM8q+N63VlWftsNnfuo8x0="
  - secure "A3+2qedOJQZac/cIbGzV4W4qGRUx4ewCBUgnwLaG50hoYTY8JzQ+Bje7nDX1IGZiUhm3MPenKKYS5cvJQ9C18s97f4z4BjurMCOLU9UyqbBe4d80Y07asnQf/psa3jxCwPOGuTXMxNYhnCLq09y49A9HO/tdMp839sHYoMEQ3TE/h203HweNfZClsa/uq18WAw6IffeZqNm78RkwVMF1YRZJApZqzogXX1VdrOX3yVf512UcSJ/QVp8IAZSeEyksLinxQ5ENCM80yYkdPP/7bsek0P6P2yD1RrGYHBmVBWAQ3e27UjMCaqcKkvCUqzygzdjhX/6qq/Qrtf7N5X9vdH+HiqjIoTlQ/c+r6eCtmrFm1QB0BeVuORR/JMzcRHYBGiQTeezNAdMO8jHH8VtDnPzKNFN+tfX82vOcVE6eRGCIMZs1HBn1PNf6QiJRxhIwjQlc5yco6mtA8qs1J9UShJ1SjTSHsC/6/y0kL3aaNe988pPRUx2QW3kKVY9S2M7Ok7QLDIXkHLjutfgBsKsHSqvFsOuITeMsg31D51O/wNH8kuPWoqpiXf00PNoN/AcCtSTF6HSJ4Gn9lUn8EIAMw8wRihFFEWD/I3tuDswDzHwznOe075qHC7EPmUuCalvwe/sFVrXtgkKn19jZC+OWe+w/UTipAgCGHjJtscYp8R8="
  - secure "eYLbGyrmiL6JrZeYMDr90ikYtozCp1n24DZTIIPlAIZsPAg8FL2jpJXDaYVmeu2UmexxjtXnlUSkmfL+RY8gNHcSb9ckt+y4BY9ImAWu3MeMW/GkdiJQE156vbsg6DWF+SDk5cJL3ABiGbgFyKq4SfcC7vhOHRUGzgNHdYKNOi1hlCxfay0MCnuxY/CJrNApMgpAnt538X6HKUgvcnye0q0bx8NoG78IdU8fOA1k2ID3C7zpGVtnsgwOvTNVCAf80ys6YMfnY5UcEMVRM3WRQJrc1Iz4k2RQ+ZvVK5BaMWcFyq7gesZFmDkT2dqLqBCOWtSgV/KRYkqysebFzM30nSoDiBEcTHbTT5fBxKDU0FXWtTlPKLLtmFnizgunY82WWZOb8fHyP47kAyqzsMEB3BtLDPG2bl+iKFmKw7COd6EEoOiospcfHaY6Pc798u9Bk8zAVucXDJwtqHi17czr0bc74NBmriATmluDGao8jv80W+gqs3aRVeVdM5hvUSV5DLg07ArEGF7hEDOnM1bw/Em+kdpK6llBEV/OpzoxXw/roAy20HNc7KaYfY+lccXyB1sjLXTWU0z9JdeHZC5ky5c+N/YQqOhL0u44MD1AocFFcw/908r8nGhzyusXa9NOWRU5HObOoHBAougm9wSpJQN5J8Xasnwy4wNkQq1kASc="
  - secure "B69sZEcktbst8szLfnfHc/zjX5bZZtXz387wjvBoReD+cBorT/JSIShLzjH1n4xrW5EtYjzFdlLLy4S+3hf8a9otRoepvQX3OhgfLGo8ISuSH4XaT3C5NTjlSQcjcBxFVOkHWs6qf8x4Zb9H0IyM/0cuqzhGtTCBiyTXqQ/lbCiLBqxdTRJNPwu8zavjIOtntzxfhSJKpfl71KiwujrbFPAlSBOSp9ZnT6ktLMu0UpFUQon/HZEChBuwp2uIJ2adnNSpsy30yYx/XqKd1Y8TMc4ST2Jqk+hzkewbik2GKFkcsKoqHy3U5325wc8pFu81ZhesnBgewGky8PkjDjFzGqSwjyws8iPKON9hnt+M86iuB5/38M0h0ETmArOwIO7r8Al08tNxgg085i4I3PQ8xQfNbKUIws84Hak1QapNPf3R0gmIO6cdlU3LExv5yojldkX8EuyVl30eo/fWdSLafikquPSJN0HnoeWCiYvyUgk1+GXwJVbXMCm1ZxGg1aSBtKuiqFto6/il4ICo8LKteFbIVCsRpAaVWkQ5UjqGZsCXubYjHLTarkNAdNShDjzDwc+RZl3FhPwAPBv7VsV62fGu2470QijuPGZkUpaPssLyiZVfm+jDeLZDP8SnckYcD/iX2WhmEdFAl+JfOE8h+Pydbkez12InMz5TobLPTOk="

# Deploy updated container over ssh
deploy:
  provider: script
  script: ssh -i /tmp/travis_deploy_rsa $DEPLOY_USER@$SERVER_HOST "sudo docker pull $IMAGE_NAME:$TAG && sudo docker rm -f app || true && sudo docker run -d --network net -p 80:8080 --name app $IMAGE_NAME:$TAG"
  on:
    branch: master



